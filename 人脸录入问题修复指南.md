# 人脸录入问题诊断和修复指南

## 问题描述

用户反馈无法正常录入人脸到系统中。

## 可能的原因

### 1. MediaPipe模型加载失败
**症状**: 点击"添加"按钮后长时间无响应,或提示"未检测到人脸"

**原因**: MediaPipe模型从CDN加载可能失败
```typescript
solutionPath: "https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"
```

**解决方案**: 
- 使用本地模型文件
- 或使用更稳定的CDN(如unpkg)

### 2. 图片格式或大小问题
**症状**: 上传图片后提示错误

**原因**:
- 图片文件过大(>10MB)
- 图片格式不支持
- 图片分辨率过高

**解决方案**:
- 限制图片大小
- 压缩图片
- 转换为标准格式(JPEG/PNG)

### 3. 人脸检测失败
**症状**: 提示"未检测到人脸"

**原因**:
- 照片中没有人脸
- 人脸太小或太模糊
- 人脸角度过大
- 光线太暗

**解决方案**:
- 使用清晰的正面人脸照片
- 确保人脸占图片的30%以上
- 光线充足

### 4. 浏览器兼容性问题
**症状**: 某些浏览器无法使用

**原因**:
- 浏览器不支持WebGL
- 浏览器版本过旧

**解决方案**:
- 使用Chrome/Edge最新版本
- 启用硬件加速

## 诊断步骤

### 1. 打开浏览器开发者工具
```
F12 或 右键 -> 检查
```

### 2. 查看Console标签
查找以下错误信息:
- `Failed to load face detector`
- `No face detected in image`
- `Error extracting face from image`
- `Failed to fetch`

### 3. 查看Network标签
检查以下请求是否成功:
- `@mediapipe/face_mesh` 相关文件
- 图片上传请求

### 4. 测试步骤
1. 点击"添加人员"
2. 输入姓名
3. 上传一张清晰的正面人脸照片
4. 观察Console输出
5. 查看是否有错误信息

## 快速修复方案

### 方案1: 改用unpkg CDN

修改 `client/src/lib/faceRecognition.ts`:

```typescript
const detectorConfig: faceLandmarksDetection.MediaPipeFaceMeshMediaPipeModelConfig = {
  runtime: "mediapipe",
  solutionPath: "https://unpkg.com/@mediapipe/face_mesh@0.4.1633559619", // 使用unpkg
  maxFaces: 10,
  refineLandmarks: true,
};
```

### 方案2: 添加图片预处理

修改 `client/src/pages/Admin.tsx`:

```typescript
const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (!file) return;

  // 检查文件大小(限制5MB)
  if (file.size > 5 * 1024 * 1024) {
    toast.error("图片文件过大,请选择小于5MB的图片");
    return;
  }

  // 检查文件类型
  if (!file.type.startsWith("image/")) {
    toast.error("请选择图片文件");
    return;
  }

  const reader = new FileReader();
  reader.onload = async (event) => {
    const imageData = event.target?.result as string;
    
    // 压缩图片
    const img = new Image();
    img.src = imageData;
    await new Promise((resolve) => {
      img.onload = resolve;
    });

    // 如果图片太大,进行缩放
    let canvas = document.createElement("canvas");
    let ctx = canvas.getContext("2d");
    
    let width = img.width;
    let height = img.height;
    const maxSize = 1024;
    
    if (width > maxSize || height > maxSize) {
      if (width > height) {
        height = (height / width) * maxSize;
        width = maxSize;
      } else {
        width = (width / height) * maxSize;
        height = maxSize;
      }
    }
    
    canvas.width = width;
    canvas.height = height;
    ctx?.drawImage(img, 0, 0, width, height);
    
    const compressedImage = canvas.toDataURL("image/jpeg", 0.9);
    setImagePreview(compressedImage);
    
    // 人脸质量检测
    toast.info("正在检测人脸质量...");
    const quality = await evaluateFaceQuality(img);
    setFaceQuality(quality);
    
    if (quality.valid) {
      toast.success(`人脸质量良好 (${quality.score}/100)`);
    } else {
      toast.warning(`人脸质量较低 (${quality.score}/100): ${quality.issues.join(", ")}`);
    }
  };
  reader.readAsDataURL(file);
};
```

### 方案3: 添加更详细的错误提示

修改 `client/src/pages/Admin.tsx` 的 `handleSubmit`:

```typescript
const handleSubmit = async () => {
  if (!name || !imagePreview) {
    toast.error("请填写姓名并上传照片");
    return;
  }

  try {
    toast.info("正在加载人脸检测模型...");
    
    const img = new Image();
    img.src = imagePreview;
    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = () => reject(new Error("图片加载失败"));
    });

    toast.info("正在提取人脸特征...");
    const faceEmbedding = await extractFaceFromImage(img);
    
    if (!faceEmbedding) {
      toast.error("未检测到人脸,请确保:\n1. 照片中有清晰的人脸\n2. 人脸正对镜头\n3. 光线充足\n4. 人脸占图片30%以上");
      return;
    }

    toast.info("人脸特征提取成功,正在保存...");
    
    createMutation.mutate({
      name,
      description,
      imageData: imagePreview,
      faceEmbedding: JSON.stringify(faceEmbedding),
    });
  } catch (error) {
    console.error("Error:", error);
    if (error instanceof Error) {
      toast.error(`错误: ${error.message}`);
    } else {
      toast.error("人脸特征提取失败,请重试");
    }
  }
};
```

### 方案4: 添加模型预加载

修改 `client/src/pages/Home.tsx`:

```typescript
useEffect(() => {
  // 预加载人脸检测模型
  const preloadModels = async () => {
    try {
      toast.info("正在加载人脸检测模型...");
      await initFaceDetector();
      toast.success("人脸检测模型加载完成");
    } catch (error) {
      console.error("Failed to preload face detector:", error);
      toast.error("人脸检测模型加载失败,人脸识别功能可能无法使用");
    }
  };
  
  preloadModels();
}, []);
```

## 推荐的完整修复流程

### 1. 更新CDN地址
```bash
cd /home/ubuntu/tfjs-object-detection
```

编辑 `client/src/lib/faceRecognition.ts`:
```typescript
solutionPath: "https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1633559619",
```

### 2. 添加图片大小限制和压缩
在Admin.tsx的handleImageUpload中添加大小检查和压缩逻辑

### 3. 改进错误提示
在handleSubmit中添加更详细的错误信息

### 4. 添加模型预加载
在应用启动时预加载模型

### 5. 测试
1. 重启开发服务器
2. 清除浏览器缓存
3. 尝试添加人员
4. 查看Console输出

## 测试用例

### 测试1: 正常情况
- 使用清晰的正面人脸照片
- 文件大小 < 2MB
- 格式: JPEG/PNG
- 预期: 成功添加

### 测试2: 无人脸
- 使用风景照片
- 预期: 提示"未检测到人脸"

### 测试3: 文件过大
- 使用 > 5MB 的图片
- 预期: 提示"图片文件过大"

### 测试4: 模糊照片
- 使用模糊的人脸照片
- 预期: 提示"人脸质量较低"

## 常见问题FAQ

### Q1: 为什么一直提示"未检测到人脸"?
A: 
1. 确保照片中有清晰的人脸
2. 人脸要正对镜头
3. 光线要充足
4. 人脸要占图片的30%以上

### Q2: 为什么上传后没有反应?
A:
1. 检查浏览器Console是否有错误
2. 检查网络连接
3. 尝试刷新页面
4. 清除浏览器缓存

### Q3: 为什么有时候能成功,有时候失败?
A:
1. 可能是网络不稳定导致模型加载失败
2. 可能是照片质量不稳定
3. 建议使用质量更好的照片

### Q4: 支持哪些图片格式?
A: JPEG, PNG, WebP, GIF(静态)

### Q5: 图片大小有限制吗?
A: 建议 < 5MB,推荐 < 2MB

## 临时解决方案

如果以上方案都无法解决,可以尝试:

### 方案A: 使用批量导入
1. 准备多张照片
2. 文件名为人员姓名
3. 使用"批量导入"功能

### 方案B: 使用其他浏览器
1. 尝试Chrome最新版
2. 尝试Edge最新版
3. 确保启用硬件加速

### 方案C: 检查网络
1. 确保能访问CDN
2. 尝试使用VPN
3. 检查防火墙设置

## 需要用户提供的信息

如果问题仍然存在,请提供:

1. **浏览器信息**
   - 浏览器名称和版本
   - 操作系统

2. **错误信息**
   - Console中的完整错误信息
   - Network标签中失败的请求

3. **照片信息**
   - 照片格式
   - 照片大小
   - 照片分辨率

4. **操作步骤**
   - 详细的操作流程
   - 出现问题的时间点

## 联系支持

如果以上方法都无法解决问题,请:
1. 在GitHub提Issue
2. 提供详细的错误信息
3. 提供测试用的照片(如果可以)

---

**最后更新**: 2025-10-20
**版本**: v2.0.0

