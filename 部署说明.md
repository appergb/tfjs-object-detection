# TensorFlow.js 物体识别系统 - 部署说明

## 项目概述

基于 TensorFlow.js 的实时物体检测和人脸识别 Web 应用,支持摄像头实时检测、人员管理和识别记录查询。

## 访问信息

### 公网访问地址
```
https://3000-id4v1kanvtghudb5uxkje-8418088f.manus-asia.computer
```

### 默认管理员账户
- **用户名**: LBX
- **密码**: 198305
- **角色**: 管理员

## 已完成的修改

### 1. 移除 OAuth 认证
- 删除了原有的 OAuth 第三方认证系统
- 移除了对外部认证服务器的依赖

### 2. 实现本地认证系统
- 添加了基于用户名/密码的本地登录功能
- 使用 bcryptjs 进行密码哈希加密存储
- 创建了独立的登录页面 `/login`
- 实现了会话管理和 Cookie 认证

### 3. 数据库修改
- 在 `users` 表中添加了 `password` 字段用于存储密码哈希
- 创建了默认管理员账户 LBX

### 4. 新增文件
- `server/_core/localAuth.ts` - 本地认证路由处理
- `client/src/pages/Login.tsx` - 登录页面组件
- `init-default-user.js` - 默认用户初始化脚本

## 功能特性

### 核心功能
- ✅ **实时物体检测** - 使用 COCO-SSD 模型识别 80 种常见物体
- ✅ **人脸识别** - 基于 MediaPipe FaceMesh 进行人脸检测和特征提取
- ✅ **人脸比对** - 自动比对数据库中的已知人员
- ✅ **识别记录** - 保存和查看历史识别记录

### 管理功能
- ✅ **本地认证** - 用户名/密码登录系统
- ✅ **人员管理** - 管理员可添加/删除人员信息
- ✅ **数据库** - MySQL 数据持久化
- ✅ **会话管理** - 基于 JWT 的会话令牌

## 技术栈

### 前端
- React 19
- TypeScript
- TensorFlow.js (COCO-SSD, MediaPipe FaceMesh)
- Tailwind CSS 4
- shadcn/ui

### 后端
- Node.js
- Express
- tRPC
- Drizzle ORM
- MySQL 8.0
- bcryptjs (密码加密)

## 使用说明

### 1. 访问系统
打开浏览器访问公网地址

### 2. 登录
- 点击右上角"登录"按钮
- 输入用户名: LBX
- 输入密码: 198305
- 点击"登录"按钮

### 3. 物体检测
1. 在主页点击"开始检测"按钮
2. 授予摄像头权限
3. 系统会自动识别画面中的物体
4. 检测结果实时显示在左侧列表

### 4. 人员管理(管理员功能)
1. 登录后点击"人员管理"菜单
2. 点击"添加人员"上传人脸照片
3. 系统自动提取人脸特征并保存
4. 在物体识别页面可以识别已添加的人员

### 5. 查看识别记录
1. 点击"识别记录"菜单
2. 查看历史识别记录
3. 包含识别时间、人员信息、检测物体等

## 本地开发

### 环境要求
- Node.js >= 18.0.0
- pnpm >= 8.0.0
- MySQL >= 8.0

### 启动步骤

1. **启动 MySQL 服务**
```bash
sudo systemctl start mysql
```

2. **安装依赖**
```bash
cd /home/ubuntu/tfjs-object-detection
pnpm install
```

3. **初始化数据库**
```bash
pnpm db:push
```

4. **创建默认用户**
```bash
node init-default-user.js
```

5. **启动开发服务器**
```bash
pnpm dev
```

6. **访问应用**
```
http://localhost:3000
```

## 数据库配置

当前配置 (`.env` 文件):
```env
DATABASE_URL=mysql://root:password@localhost:3306/tfjs_detection
JWT_SECRET=tfjs-detection-jwt-secret-key-2024
PORT=3000
```

## 安全说明

1. **密码存储**: 使用 bcryptjs 进行密码哈希,不存储明文密码
2. **会话管理**: 使用 JWT 令牌进行会话验证
3. **Cookie 安全**: 设置了 HttpOnly 和 Secure 标志
4. **默认密码**: 建议在生产环境中修改默认管理员密码

## 添加新用户

可以使用注册接口添加新用户:

```bash
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "newuser",
    "password": "password123",
    "name": "New User",
    "email": "user@example.com"
  }'
```

或者直接在数据库中添加:

```javascript
// 使用 init-default-user.js 作为模板
const hashedPassword = await bcrypt.hash('your-password', 10);
await connection.execute(
  `INSERT INTO users (id, name, email, password, loginMethod, role, createdAt, lastSignedIn) 
   VALUES (?, ?, ?, ?, ?, ?, NOW(), NOW())`,
  ['username', 'Display Name', 'email@example.com', hashedPassword, 'local', 'user']
);
```

## 故障排除

### 1. 无法连接数据库
```bash
# 检查 MySQL 服务状态
sudo systemctl status mysql

# 启动 MySQL
sudo systemctl start mysql
```

### 2. 端口被占用
项目会自动寻找可用端口(3000-3020),如果需要指定端口:
```bash
PORT=3001 pnpm dev
```

### 3. 模型加载失败
确保网络连接正常,TensorFlow.js 模型需要从 CDN 下载

## 项目结构

```
tfjs-object-detection/
├── client/                 # 前端代码
│   └── src/
│       ├── pages/         # 页面组件
│       │   ├── Home.tsx   # 物体检测主页
│       │   ├── Login.tsx  # 登录页面
│       │   ├── Admin.tsx  # 人员管理
│       │   └── History.tsx # 识别记录
│       └── lib/           # 工具库
├── server/                # 后端代码
│   ├── _core/
│   │   ├── localAuth.ts  # 本地认证
│   │   ├── context.ts    # tRPC 上下文
│   │   └── index.ts      # 服务器入口
│   └── routers/          # API 路由
├── drizzle/              # 数据库 Schema
│   └── schema.ts
└── init-default-user.js  # 用户初始化脚本
```

## 维护建议

1. **定期备份数据库**
```bash
mysqldump -u root -p tfjs_detection > backup.sql
```

2. **更新依赖包**
```bash
pnpm update
```

3. **监控日志**
服务器日志会输出到控制台,建议使用 PM2 等工具进行进程管理

4. **修改默认密码**
登录后建议立即修改默认管理员密码

---

**部署完成时间**: 2025-10-20  
**部署环境**: Ubuntu 22.04 + Node.js 22.13.0 + MySQL 8.0  
**开发者**: Manus AI Agent

